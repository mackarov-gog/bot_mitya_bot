name: Deploy Mitya Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ШАГ 1: Копируем файлы на сервер. 
      # Очищаем папку перед копированием, чтобы не было конфликтов версий.
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "."
          target: "~/mitya_bot"
          rm: true 

      # ШАГ 2: Сборка и запуск через SSH
      - name: Build and Run Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/mitya_bot
            echo "--- СПИСОК ФАЙЛОВ НА СЕРВЕРЕ ---"
            ls -la
            
            # Проверяем наличие Dockerfile (защита от ошибок)
            if [ ! -f Dockerfile ]; then
              echo "ОШИБКА: Dockerfile не найден в папке mitya_bot!"
              exit 1
            fi

            # Останавливаем и удаляем старый контейнер
            docker stop mitya-bot-container || true
            docker rm mitya-bot-container || true
            
            # Сборка образа (займет время из-за Whisper)
            docker build -t mitya-bot-image .
            
            # Запуск
            docker run -d \
              --name mitya-bot-container \
              --restart unless-stopped \
              -e BOT_TOKEN=${{ secrets.BOT_TOKEN }} \
              mitya-bot-image